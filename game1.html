<!DOCTYPE html>
<html>
<head>
<title>RUN TO WIN - Ultimate Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;overflow:hidden;background:black;}
#score{
 position:absolute;top:20px;right:20px;
 color:white;font-size:22px;font-weight:bold;z-index:2;
}
#gameOver{
 position:absolute;top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:rgba(0,0,0,0.9);
 color:white;padding:30px;border-radius:10px;
 display:none;text-align:center;z-index:3;
}
button{padding:10px 20px;margin-top:15px;cursor:pointer;}
</style>
</head>
<body>

<div id="score">Score: 0</div>

<div id="gameOver">
<h2>Game Over!</h2>
<button onclick="goScore()">View Scorecard</button>
</div>

<!-- SOUND EFFECTS -->
<audio id="bgMusic" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c8c8a73467.mp3" loop></audio>
<audio id="jumpSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_45c6f8b5f3.mp3"></audio>
<audio id="coinSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_5c61c3db0e.mp3"></audio>
<audio id="powerSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_4f7f9b0f11.mp3"></audio>
<audio id="gameOverSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_0c4c89b5d0.mp3"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>

<script>

let scene=new THREE.Scene();
scene.background=new THREE.Color(0x1a1a1a);

let camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
let renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

// LIGHTING
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
let dLight=new THREE.DirectionalLight(0xffffff,1);
dLight.position.set(5,10,7);
scene.add(dLight);

// ROAD
let road=new THREE.Mesh(
 new THREE.PlaneGeometry(30,2000),
 new THREE.MeshStandardMaterial({color:0x444444})
);
road.rotation.x=-Math.PI/2;
scene.add(road);

// TEMPLE RUINS
for(let i=0;i<50;i++){
 let pillar=new THREE.Mesh(
  new THREE.CylinderGeometry(1,1,8,16),
  new THREE.MeshStandardMaterial({color:0x888888})
 );
 pillar.position.set(Math.random()>0.5?15:-15,4,-i*40);
 scene.add(pillar);
}

// VARIABLES
let player,monster,mixer,monsterMixer,actions={};
let clock=new THREE.Clock();
let lane=1;
let lanes=[-6,0,6];
let speed=0.45;
let score=0;
let jump=false,slide=false;
let velocity=0,gravity=-0.02;
let shield=false,magnet=false;
let obstacles=[],coins=[],powerups=[];
let gameOver=false;

// LOAD PLAYER
let loader=new THREE.GLTFLoader();
loader.load(
'https://threejs.org/examples/models/gltf/Soldier.glb',
function(gltf){
 player=gltf.scene;
 player.scale.set(2,2,2);
 player.position.set(0,0,-5);
 scene.add(player);

 mixer=new THREE.AnimationMixer(player);
 gltf.animations.forEach(clip=>{
  actions[clip.name]=mixer.clipAction(clip);
 });
 actions["Run"].play();
});

// LOAD MONSTER
loader.load(
'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
function(gltf){
 monster=gltf.scene;
 monster.scale.set(2,2,2);
 monster.position.set(0,0,5);
 scene.add(monster);
 monsterMixer=new THREE.AnimationMixer(monster);
 monsterMixer.clipAction(gltf.animations[0]).play();
});

// SHIELD GLOW
let shieldGlow=new THREE.Mesh(
 new THREE.SphereGeometry(3,32,32),
 new THREE.MeshBasicMaterial({color:0x00ffff,transparent:true,opacity:0.3})
);
shieldGlow.visible=false;
scene.add(shieldGlow);

// MAGNET GLOW
let magnetGlow=new THREE.Mesh(
 new THREE.SphereGeometry(4,32,32),
 new THREE.MeshBasicMaterial({color:0xff00ff,transparent:true,opacity:0.25})
);
magnetGlow.visible=false;
scene.add(magnetGlow);

// SPAWN FUNCTIONS
function spawnObstacle(){
 let colors=[0xaa5500,0x3333ff,0xff0000];
 let obs=new THREE.Mesh(
  new THREE.BoxGeometry(3,4,3),
  new THREE.MeshStandardMaterial({color:colors[Math.floor(Math.random()*3)]})
 );
 obs.position.set(lanes[Math.floor(Math.random()*3)],2,-200);
 scene.add(obs);
 obstacles.push(obs);
}

function spawnCoin(){
 let coin=new THREE.Mesh(
  new THREE.TorusGeometry(1,0.4,16,100),
  new THREE.MeshStandardMaterial({color:0xffff00})
 );
 coin.position.set(lanes[Math.floor(Math.random()*3)],2,-200);
 scene.add(coin);
 coins.push(coin);
}

function spawnPower(){
 let type=Math.random()>0.5?"shield":"magnet";
 let p=new THREE.Mesh(
  new THREE.SphereGeometry(1.5,16,16),
  new THREE.MeshStandardMaterial({color:type=="shield"?0x00ffff:0xff00ff})
 );
 p.userData=type;
 p.position.set(lanes[Math.floor(Math.random()*3)],2,-200);
 scene.add(p);
 powerups.push(p);
}

// KEYBOARD
document.addEventListener("keydown",e=>{
 if(e.key==="ArrowLeft"&&lane>0) lane--;
 if(e.key==="ArrowRight"&&lane<2) lane++;
 if(e.key==="ArrowUp"&&!jump){
  jump=true; velocity=0.3;
  document.getElementById("jumpSound").play();
 }
 if(e.key==="ArrowDown"){
  slide=true;
  setTimeout(()=>slide=false,1000);
 }
});

// MOBILE SWIPE
let startX=0,startY=0;
document.addEventListener("touchstart",e=>{
 startX=e.changedTouches[0].screenX;
 startY=e.changedTouches[0].screenY;
});
document.addEventListener("touchend",e=>{
 let dx=e.changedTouches[0].screenX-startX;
 let dy=e.changedTouches[0].screenY-startY;

 if(Math.abs(dx)>Math.abs(dy)){
  if(dx>50&&lane<2) lane++;
  if(dx<-50&&lane>0) lane--;
 } else {
  if(dy<-50&&!jump){ jump=true; velocity=0.3; }
  if(dy>50){ slide=true; setTimeout(()=>slide=false,1000); }
 }
});

// GAME LOOP
function animate(){
 if(gameOver) return;
 requestAnimationFrame(animate);

 let delta=clock.getDelta();
 if(mixer) mixer.update(delta);
 if(monsterMixer) monsterMixer.update(delta);

 if(player){
  player.position.x=lanes[lane];

  if(jump){
   player.position.y+=velocity;
   velocity+=gravity;
   if(player.position.y<=0){
    player.position.y=0;
    jump=false;
   }
  }

  shieldGlow.position.copy(player.position);
  magnetGlow.position.copy(player.position);
 }

 obstacles.forEach(o=>{
  o.position.z+=speed;
  if(player&&o.position.distanceTo(player.position)<2&&!shield)
   endGame();
 });

 coins.forEach(c=>{
  c.position.z+=speed;
  c.rotation.y+=0.1;
  if(magnet&&player)
   c.position.x+=(player.position.x-c.position.x)*0.05;
  if(player&&c.position.distanceTo(player.position)<2){
   score+=50;
   document.getElementById("coinSound").play();
   scene.remove(c);
  }
 });

 powerups.forEach(p=>{
  p.position.z+=speed;
  if(player&&p.position.distanceTo(player.position)<2){
   document.getElementById("powerSound").play();
   if(p.userData=="shield"){
    shield=true; shieldGlow.visible=true;
    setTimeout(()=>{shield=false;shieldGlow.visible=false;},5000);
   } else{
    magnet=true; magnetGlow.visible=true;
    setTimeout(()=>{magnet=false;magnetGlow.visible=false;},5000);
   }
   scene.remove(p);
  }
 });

 if(monster){
  monster.position.z-=0.01;
  if(monster.position.z-player.position.z<2)
   endGame();
 }

 score++;
 speed+=0.00005;
 document.getElementById("score").innerText="Score: "+score;

 camera.position.x=lanes[lane];
 camera.position.y=6;
 camera.position.z=8;
 camera.lookAt(0,1,-20);

 renderer.render(scene,camera);
}

function endGame(){
 gameOver=true;
 document.getElementById("gameOver").style.display="block";
 document.getElementById("gameOverSound").play();

 localStorage.setItem("lastScore",score);
 let name=localStorage.getItem("playerName");
 let board=JSON.parse(localStorage.getItem("leaderboard"))||[];
 board.push({name:name,score:score});
 board.sort((a,b)=>b.score-a.score);
 localStorage.setItem("leaderboard",JSON.stringify(board));
}

function goScore(){
 window.location.href="score1.html";
}

// Start music on first tap
document.body.addEventListener("click",()=>{
 document.getElementById("bgMusic").play();
},{once:true});

setInterval(spawnObstacle,2000);
setInterval(spawnCoin,1500);
setInterval(spawnPower,7000);

animate();

</script>
</body>
  </html>
